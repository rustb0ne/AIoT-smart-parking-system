<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>IoT OTA Update</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                background: #f5f5f5;
                min-height: 100vh;
                padding: 20px;
            }

            .container {
                max-width: 900px;
                margin: 0 auto;
                background: white;
                border-radius: 15px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                overflow: hidden;
            }

            .header {
                background: #667eea;
                color: white;
                padding: 30px;
                text-align: center;
            }

            .header h1 {
                font-size: 2.5em;
                margin-bottom: 10px;
            }

            .header p {
                opacity: 0.9;
                font-size: 1.1em;
            }

            .content {
                padding: 40px;
            }

            .section {
                margin-bottom: 40px;
            }

            .section h2 {
                color: #667eea;
                margin-bottom: 20px;
                font-size: 1.5em;
                border-bottom: 2px solid #667eea;
                padding-bottom: 10px;
            }

            .form-group {
                margin-bottom: 25px;
            }

            label {
                display: block;
                margin-bottom: 8px;
                color: #333;
                font-weight: 600;
                font-size: 1.05em;
            }

            select,
            input[type="file"] {
                width: 100%;
                padding: 12px 15px;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                font-size: 1em;
                transition: all 0.3s;
            }

            select:focus,
            input[type="file"]:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

            .btn {
                padding: 14px 30px;
                border: none;
                border-radius: 8px;
                font-size: 1.1em;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .btn-primary {
                background: #667eea;
                color: white;
                width: 100%;
            }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
            }

            .btn-primary:active {
                transform: translateY(0);
            }

            .btn-upload {
                background: #48bb78;
                color: white;
                width: 100%;
                margin-top: 10px;
            }

            .btn-upload:hover {
                background: #38a169;
                transform: translateY(-2px);
                box-shadow: 0 10px 25px rgba(72, 187, 120, 0.4);
            }

            .status {
                margin-top: 20px;
                padding: 15px;
                border-radius: 8px;
                display: none;
            }

            .status.success {
                background: #c6f6d5;
                color: #22543d;
                border-left: 4px solid #48bb78;
            }

            .status.error {
                background: #fed7d7;
                color: #742a2a;
                border-left: 4px solid #f56565;
            }

            .status.info {
                background: #bee3f8;
                color: #2c5282;
                border-left: 4px solid #4299e1;
            }

            .firmware-list {
                background: #f7fafc;
                padding: 20px;
                border-radius: 8px;
                margin-top: 20px;
            }

            .firmware-list h3 {
                color: #667eea;
                margin-bottom: 15px;
            }

            .firmware-item {
                background: white;
                padding: 12px 15px;
                margin-bottom: 10px;
                border-radius: 6px;
                border: 1px solid #e0e0e0;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .firmware-name {
                font-weight: 600;
                color: #333;
            }

            .firmware-meta {
                color: #666;
                font-size: 0.9em;
            }

            .device-info {
                background: #edf2f7;
                padding: 15px;
                border-radius: 8px;
                margin-top: 15px;
                display: none;
            }

            .device-info p {
                margin: 5px 0;
                color: #4a5568;
            }

            .device-info strong {
                color: #2d3748;
            }

            .spinner {
                border: 3px solid #f3f3f3;
                border-top: 3px solid #667eea;
                border-radius: 50%;
                width: 30px;
                height: 30px;
                animation: spin 1s linear infinite;
                display: inline-block;
                margin-right: 10px;
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            .loading {
                display: none;
                text-align: center;
                margin-top: 15px;
                color: #667eea;
                font-weight: 600;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>OTA Update Manager</h1>
            </div>

            <div class="content">
                <!-- Upload Firmware Section -->
                <div class="section">
                    <h2>Upload Firmware</h2>
                    <div class="form-group">
                        <label for="firmware-file">Chọn file firmware (.bin)</label>
                        <input type="file" id="firmware-file" accept=".bin" />
                    </div>
                    <button class="btn btn-upload" onclick="uploadFirmware()">Upload Firmware</button>
                    <div id="upload-status" class="status"></div>
                </div>

                <!-- Firmware List -->
                <div class="firmware-list">
                    <h3>Firmware có sẵn</h3>
                    <div id="firmware-list-content">
                        <p style="color: #999">Đang tải danh sách...</p>
                    </div>
                </div>

                <!-- OTA Update Section -->
                <div class="section">
                    <h2>OTA Update</h2>

                    <div class="form-group">
                        <label for="device-select">Chọn thiết bị</label>
                        <select id="device-select" onchange="updateDeviceInfo()">
                            <option value="">-- Chọn thiết bị --</option>
                            {% for device_id, device in devices.items() %}
                            <option value="{{ device_id }}">{{ device.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div id="device-info" class="device-info">
                        <p><strong>Device ID:</strong> <span id="info-device-id"></span></p>
                        <p><strong>MQTT Topic:</strong> <span id="info-topic"></span></p>
                    </div>

                    <div class="form-group">
                        <label for="firmware-select">Chọn firmware</label>
                        <select id="firmware-select">
                            <option value="">-- Chọn firmware --</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" onclick="triggerUpdate()">Update</button>

                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        Đang gửi lệnh update...
                    </div>

                    <div id="ota-status" class="status"></div>
                </div>
            </div>
        </div>

        <script>
            // @ts-nocheck - This is a Jinja2 template file, not pure JavaScript
            const devices = {{ devices | tojson }};

            // Load firmware list on page load
            loadFirmwareList();

            function updateDeviceInfo() {
                const select = document.getElementById('device-select');
                const deviceId = select.value;
                const infoDiv = document.getElementById('device-info');

                if (deviceId && devices[deviceId]) {
                    const device = devices[deviceId];
                    document.getElementById('info-device-id').textContent = deviceId;
                    document.getElementById('info-topic').textContent = device.topic;
                    document.getElementById('info-firmware').textContent = device.firmware_file;
                    infoDiv.style.display = 'block';
                } else {
                    infoDiv.style.display = 'none';
                }
            }

            async function loadFirmwareList() {
                try {
                    const response = await fetch('/ota/api/firmware/list');
                    const data = await response.json();

                    const listDiv = document.getElementById('firmware-list-content');
                    const firmwareSelect = document.getElementById('firmware-select');

                    // Clear old options
                    firmwareSelect.innerHTML = '<option value="">-- Chọn firmware --</option>';

                    if (data.firmware_files && data.firmware_files.length > 0) {
                        listDiv.innerHTML = '';

                        data.firmware_files.forEach(fw => {
                            // Add to list display
                            const item = document.createElement('div');
                            item.className = 'firmware-item';
                            item.innerHTML = `
                                <div>
                                    <div class="firmware-name">${fw.filename}</div>
                                    <div class="firmware-meta">${fw.size_kb} KB • ${fw.modified}</div>
                                </div>
                            `;
                            listDiv.appendChild(item);

                            // Add to select dropdown
                            const option = document.createElement('option');
                            option.value = fw.filename;
                            option.textContent = `${fw.filename} (${fw.size_kb} KB)`;
                            firmwareSelect.appendChild(option);
                        });
                    } else {
                        listDiv.innerHTML = '<p style="color: #999;">Chưa có firmware nào. Hãy upload file .bin</p>';
                    }
                } catch (error) {
                    console.error('Error loading firmware list:', error);
                }
            }

            async function uploadFirmware() {
                const fileInput = document.getElementById('firmware-file');
                const statusDiv = document.getElementById('upload-status');

                if (!fileInput.files || fileInput.files.length === 0) {
                    showStatus(statusDiv, 'error', 'Vui lòng chọn file firmware');
                    return;
                }

                const file = fileInput.files[0];

                if (!file.name.endsWith('.bin')) {
                    showStatus(statusDiv, 'error', 'Chỉ chấp nhận file .bin');
                    return;
                }

                const formData = new FormData();
                formData.append('file', file);

                try {
                    showStatus(statusDiv, 'info', 'Đang upload...');

                    const response = await fetch('/ota/api/firmware/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        showStatus(statusDiv, 'success',
                            `Upload thành công: ${data.filename} (${data.size_kb} KB)`);

                        // Reload firmware list
                        loadFirmwareList();

                        // Clear file input
                        fileInput.value = '';
                    } else {
                        showStatus(statusDiv, 'error', `Lỗi: ${data.error}`);
                    }
                } catch (error) {
                    showStatus(statusDiv, 'error', `Lỗi upload: ${error.message}`);
                }
            }

            async function triggerUpdate() {
                const deviceSelect = document.getElementById('device-select');
                const firmwareSelect = document.getElementById('firmware-select');
                const statusDiv = document.getElementById('ota-status');
                const loadingDiv = document.getElementById('loading');

                const deviceId = deviceSelect.value;
                const firmwareFile = firmwareSelect.value;

                if (!deviceId) {
                    showStatus(statusDiv, 'error', 'Vui lòng chọn thiết bị');
                    return;
                }

                if (!firmwareFile) {
                    showStatus(statusDiv, 'error', 'Vui lòng chọn firmware');
                    return;
                }

                try {
                    loadingDiv.style.display = 'block';
                    statusDiv.style.display = 'none';

                    const response = await fetch('/ota/api/trigger', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            device_id: deviceId,
                            firmware_file: firmwareFile
                        })
                    });

                    const data = await response.json();

                    loadingDiv.style.display = 'none';

                    if (data.success) {
                        showStatus(statusDiv, 'success',
                            `Lệnh Update đã được gửi đến ${data.device_name}
                            <br>Topic: ${data.topic}
                            <br>Firmware: ${data.firmware_file} (${(data.firmware_size / 1024).toFixed(2)} KB)
                            <br>Thiết bị sẽ tự động tải và cập nhật firmware...`);
                    } else {
                        showStatus(statusDiv, 'error', `Lỗi: ${data.error}`);
                    }
                } catch (error) {
                    loadingDiv.style.display = 'none';
                    showStatus(statusDiv, 'error', `Lỗi kết nối: ${error.message}`);
                }
            }

            function showStatus(element, type, message) {
                element.className = `status ${type}`;
                element.innerHTML = message;
                element.style.display = 'block';

                if (type === 'success') {
                    setTimeout(() => {
                        element.style.display = 'none';
                    }, 10000);
                }
            }
        </script>
    </body>
</html>
